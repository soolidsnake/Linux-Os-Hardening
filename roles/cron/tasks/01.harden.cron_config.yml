---
- block:

  - name: Check if cron is running
    shell: systemctl is-enabled cron
    register: cron_state
    ignore_errors: True
    when: ansible_os_family=='Debian'

  - name: Check if cron is running
    shell: systemctl is-enabled crond
    register: cron_state
    ignore_errors: True
    when: ansible_os_family=='RedHat'

  - debug: msg="{{cron_state.stderr}}"


  - name: installing cron on Debian
    apt: name=cron state=latest
    when: ansible_os_family=='Debian' and 'FAILED' in cron_state.stderr


  - name: installing cron on RedHat
    yum: name=cronie state=latest
    when: ansible_os_family=='RedHat' and 'FAILED'in cron_state.stderr


  - name: Run cron on Debian
    shell: systemctl enable cron
    when: ansible_os_family=='Debian' and (cron_state.stdout == "disabled" or 'FAILED'in cron_state.stderr)

  - name: Run cron on RedHat
    shell: systemctl enable crond
    when: ansible_os_family=='RedHat' and (cron_state.stdout == "disabled" or 'FAILED'in cron_state.stderr)


  - name: Ensure permissions on /etc/crontab are configured
    file: path="/etc/crontab" owner=root group=root mode=0600 


  - name: Ensure permissions on /etc/cron.hourly are configured
    file: path="/etc/cron.hourly" owner=root group=root mode=0700 


  - name: Ensure permissions on /etc/cron.daily are configured
    file: path="/etc/cron.daily" owner=root group=root mode=0700 


  - name: Ensure permissions on /etc/cron.weekly are configured
    file: path="/etc/cron.weekly" owner=root group=root mode=0700 


  - name: Ensure permissions on /etc/cron.monthly are configured
    file: path="/etc/cron.monthly" owner=root group=root mode=0700 


  - name: Ensure permissions on /etc/cron.d are configured
    file: path="/etc/cron.d" owner=root group=root mode=0700 


  - name: Check that the /etc/cron.allow exists
    stat:
      path: /etc/cron.allow
    register: stat_result


  - name: Create the file, if it doesnt exist already
    file:
      path: /etc/cron.allow
      state: touch
    when: stat_result.stat.exists == False 


  - name: Check that the /etc/at.allow exists
    stat:
      path: /etc/at.allow
    register: stat_result


  - name: Create the file, if it doesnt exist already
    file:
      path: /etc/at.allow
      state: touch
    when: stat_result.stat.exists == False 


  - name: Ensure permissions on /etc/cron.allow are configured
    file: path="/etc/cron.allow" owner=root group=root mode=0600


  - name: Ensure permissions on /etc/at.allow are configured
    file: path="/etc/at.allow" owner=root group=root mode=0600  


  - name: remove /etc/cron.deny
    file:
      state: absent
      path: "/etc/cron.deny"


  - name: remove /etc/at.deny
    file:
      state: absent
      path: "/etc/at.deny"
  become: yes